@page "/"
@attribute [StreamRendering]
@rendermode InteractiveServer

@using SettlersOfIdlestanGame.Components
@using SettlersOfIdlestanGame.Components.Elements
@using SettlersOfIdlestan.Model.IslandMap
@using SettlersOfIdlestan.Controller
@using SettlersOfIdlestan.Model.Civilization
@using SettlersOfIdlestan.Model.City
@using SettlersOfIdlestan.Model.Buildings
@using System.Linq
@using System.Collections.Generic
@using System.Threading
@using System.Threading.Tasks
@using System.Diagnostics

<PageTitle>Settlers of Idlestan</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="mb-0">Carte de l'île</h1>
    <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Settings</button>
        <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width:200px">
            <li>
                <button class="dropdown-item" @onclick="ExportGame">Export (sauver)</button>
            </li>
            <li>
                <button class="dropdown-item" @onclick="TriggerImport">Import (charger)</button>
            </li>
            <li>
                <button class="dropdown-item" @onclick="CheatAddResources">Cheat (ajouter 100 de chaque)</button>
            </li>
        </ul>
    </div>
    <div class="resource-capsule d-flex align-items-center px-3 py-1 rounded-pill"
         style="background:#f8f9fa;border:1px solid #ddd;min-width:220px;max-width:60%;">
        @if (State is null)
        {
            <span class="text-muted">Chargement ressources…</span>
        }
        else
        {
            @foreach (var rObj in System.Enum.GetValues(typeof(SettlersOfIdlestan.Model.IslandMap.Resource)))
            {
                var r = (SettlersOfIdlestan.Model.IslandMap.Resource)rObj;
                var qty = State.PlayerCivilization.GetResourceQuantity(r);
                <div class="me-3 d-flex align-items-center">
                    <span class="badge bg-secondary me-1" style="min-width:26px;text-align:center">
                        @r.ToString().Substring(0, 1)
                    </span>
                    <small class="text-nowrap">@r.ToString(): @qty</small>
                </div>
            }
        }
    </div>
</div>

<InputFile id="importFile" style="display:none" OnChange="OnImportFileSelected" />

<div class="mb-2">
    <button class="btn btn-primary" @onclick="Generate">Générer / Régénérer</button>
</div>

<div class="d-flex">
    <div style="flex:1;">
        @if (State is null)
        {
            <p><em>Génération en cours...</em></p>
        }
        else
        {
            <IslandMapView State="State" Controller="mainController" OnCitySelected="OnCitySelected" SelectedCity="selectedCity" />
        }
    </div>

    <div class="ms-3" style="width:320px;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Ville sélectionnée</h5>
                @if (selectedCity is null)
                {
                    <p class="text-muted">Aucune ville sélectionnée. Cliquez sur une ville dans la carte.</p>
                }
                else
                {
                    <p><strong>Civilisation :</strong> @selectedCity.CivilizationIndex</p>
                    <p><strong>Position :</strong> @selectedCity.Position</p>

                    <h6>Bâtiments</h6>
                    {
                        var built = selectedCity.Buildings ?? new List<SettlersOfIdlestan.Model.Buildings.Building>();
                        var buildables = mainController?.BuildingController?.GetBuildableBuildings(selectedCity.CivilizationIndex, selectedCity.Position) ?? new List<SettlersOfIdlestan.Model.Buildings.Building>();
                        var allTypes = Enum.GetValues(typeof(BuildingType)).Cast<BuildingType>().ToList();

                        <ul class="list-group mb-2">
                            @foreach (var t in allTypes)
                            {
                                var builtB = built.FirstOrDefault(b => b.Type == t);
                                var proto = buildables.FirstOrDefault(b => b.Type == t);

                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div title="@((builtB != null ? builtB.Description : proto?.Description ?? string.Empty))">
                                            <strong>@t</strong>
                                            @if (builtB != null)
                                            {
                                                <span> (Niveau @builtB.Level)</span>
                                            }
                                        </div>

                                        <div>
                                            @if (builtB != null && builtB.Level < builtB.MaxLevel)
                                            {
                                                <button class="btn btn-sm btn-outline-primary" @onclick="(() => UpgradeBuilding(t))">Améliorer</button>
                                            }
                                            else if (proto != null && builtB == null)
                                            {
                                                <button class="btn btn-sm btn-primary" @onclick="(() => BuildBuilding(t))">Construire</button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-secondary" disabled>Indisponible</button>
                                            }
                                        </div>
                                    </div>

                                    @* Cost line spanning full width, italic *@
                                    @if (builtB != null && builtB.Level < builtB.MaxLevel)
                                    {
                                        var upgradeCost = builtB.GetUpgradeCost(builtB.Level + 1);
                                        <div class="mt-2"><em>@FormatCost(upgradeCost)</em></div>
                                    }
                                    else if (builtB != null)
                                    {
                                        // no mention
                                    }
                                    else if (proto != null)
                                    {
                                        var buildCost = proto.GetBuildCost();
                                        <div class="mt-2"><em>@FormatCost(buildCost)</em></div>
                                    }
                                    else
                                    {
                                        <div class="mt-2"><em>Non disponible</em></div>
                                    }
                                </li>
                            }
                        </ul>
                    }

                    @if (!string.IsNullOrEmpty(sideBuildMessage))
                    {
                        <div class="mt-2 text-danger">@sideBuildMessage</div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private IslandState? State;
    private MainGameController? mainController;
    private CancellationTokenSource? renderLoopCts;
    private CancellationTokenSource? autosaveCts;
    private Task? renderLoopTask;
    private Task? autosaveTask;
    private Stopwatch? renderLoopStopwatch;
    private SettlersOfIdlestan.Model.City.City? selectedCity;
    private string? sideBuildMessage;
    private const string AutosaveKey = "settlers_autosave";
    [Inject] private IJSRuntime JS { get; set; } = default!;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Initialize main controller first
        mainController = new MainGameController();

        // Try to restore autosave from localStorage via JS interop after first render.
        // On server-side rendering the JS runtime may not be available immediately (prerendering),
        // so use a small retry loop and swallow transient failures to avoid breaking the load sequence.
        try
        {
            var saved = await TryGetLocalSaveAsync();
            if (!string.IsNullOrEmpty(saved))
            {
                var mainState = mainController.ImportMainState(saved);
                State = mainState.CurrentIslandState;
            }
        }
        catch { }

        if (State == null)
        {
            State = CreateNewDefaultState();
        }

        // start clock and render loop
        if (mainController.Clock != null)
        {
            mainController.Clock.Start();
            StartRenderLoop();
        }

        // start autosave loop
        StartAutosaveLoop();

        StateHasChanged();
    }

    // Try to call the JS localStorage helper with a small retry loop. During
    // prerendering or immediately after a refresh the JS runtime may be
    // temporarily unavailable which causes InvokeAsync to throw; swallow
    // transient errors and return null if no value could be read.
    private async Task<string?> TryGetLocalSaveAsync(int maxAttempts = 6, int delayMs = 150)
    {
        if (JS == null) return null;

        for (int attempt = 0; attempt < maxAttempts; attempt++)
        {
            try
            {
                Log("Attempting to read local save, attempt " + (attempt + 1));
                var result = await JS.InvokeAsync<string>("getLocalSave", AutosaveKey);
                Log("Successfully read local save on attempt " + (attempt + 1));
                return result;
            }
            catch
            {
                Log("Failed to read local save on attempt " + (attempt + 1));
                // transient error (JS runtime not ready / disconnected). Retry a few times.
                if (attempt == maxAttempts - 1)
                {
                    return null;
                }
                try { await Task.Delay(delayMs); } catch { }
            }
        }

        return null;
    }

    private IslandState CreateNewDefaultState()
    {
        // Ensure mainController is initialized
        if (mainController == null)
        {
            mainController = new MainGameController();
        }

        var tileData = new List<(TerrainType, int)>
        {
            (TerrainType.Forest, 4),
            (TerrainType.Hill, 3),
            (TerrainType.Pasture, 4),
            (TerrainType.Field, 4),
            (TerrainType.Mountain, 3),
            (TerrainType.Desert, 1)
        };

        var mainState = mainController.CreateNewGame(tileData, 1);
        return mainState!.CurrentIslandState!;
    }

    private async Task ExportGame()
    {
        if (mainController == null) return;

        try
        {
            var json = mainController.ExportMainState();
            // use JS to trigger download
            var fileName = $"settlers_export_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            await JS.InvokeVoidAsync("downloadFile", fileName, json);
        }
        catch (Exception ex)
        {
            sideBuildMessage = "Export failed: " + ex.Message;
        }
    }

    private async Task TriggerImport()
    {
        // trigger the hidden input click
        await JS.InvokeVoidAsync("clickElementById", "importFile");
    }

    private void CheatAddResources()
    {
        if (mainController == null || State == null)
        {
            sideBuildMessage = "Aucun jeu actif";
            StateHasChanged();
            return;
        }

        try
        {
            var player = State.PlayerCivilization;
            foreach (var rObj in System.Enum.GetValues(typeof(SettlersOfIdlestan.Model.IslandMap.Resource)))
            {
                var r = (SettlersOfIdlestan.Model.IslandMap.Resource)rObj;
                // using AddResource on Civilization
                player.AddResource(r, 100);
            }
            sideBuildMessage = "Cheat appliqué: +100 de chaque ressource";
        }
        catch (Exception ex)
        {
            sideBuildMessage = "Cheat failed: " + ex.Message;
        }
        StateHasChanged();
    }

    private async Task OnImportFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            // Ensure mainController exists before import
            if (mainController == null)
            {
                mainController = new MainGameController();
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var bytes = ms.ToArray();
            var json = System.Text.Encoding.UTF8.GetString(bytes);

            var mainState = mainController.ImportMainState(json);
            State = mainState.CurrentIslandState;

            // restart clock and render loop for imported state
            renderLoopCts?.Cancel();
            if (mainController.Clock != null)
            {
                mainController.Clock.Start();
                StartRenderLoop();
            }

            // persist imported state immediately
            var saveString = mainController.ExportMainState();
            await SaveInLocalSave(saveString);

            sideBuildMessage = "Import effectué";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            sideBuildMessage = "Import failed: " + ex.Message;
        }
    }

    private async Task Generate()
    {
        State = CreateNewDefaultState();

        // restart clock and render loop for the new controller
        renderLoopCts?.Cancel();
        if (mainController?.Clock != null)
        {
            mainController.Clock.Start();
            StartRenderLoop();
        }

        // persist immediately
        try
        {
            var saveString = mainController!.ExportMainState();
            await SaveInLocalSave(saveString);
        }
        catch { }

        StateHasChanged();
    }

    private void StartRenderLoop()
    {
        // cancel previous loop if any
        renderLoopCts?.Cancel();

        renderLoopCts = new CancellationTokenSource();
        renderLoopStopwatch = Stopwatch.StartNew();

        var token = renderLoopCts.Token;
        // store the task so DisposeAsync can await it
        renderLoopTask = RunRenderLoopAsync(token);
    }

    private async Task RunRenderLoopAsync(CancellationToken token)
    {
        try
        {
            while (!token.IsCancellationRequested)
            {
                var sw = renderLoopStopwatch!;
                var elapsed = sw.Elapsed;
                sw.Restart();

                try
                {
                    if (mainController?.Clock != null)
                    {
                        mainController.Clock.Advance(elapsed);
                    }
                }
                catch
                {
                    // ignore clock advance errors
                }

                // trigger UI update so child components can reflect clock changes
                try { await InvokeAsync(StateHasChanged); } catch { }

                // aim for ~60fps; actual delta comes from stopwatch
                await Task.Delay(16, token);
            }
        }
        catch (OperationCanceledException) { }
        catch { }
    }

    private void StartAutosaveLoop()
    {
        // cancel previous autosave if any
        autosaveCts?.Cancel();
        autosaveCts = new CancellationTokenSource();
        var token = autosaveCts.Token;

        // store the task so DisposeAsync can await it
        autosaveTask = RunAutosaveLoopAsync(token);
    }

    private async Task RunAutosaveLoopAsync(CancellationToken token)
    {
        try
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    if ((mainController is not null) && (State is not null))
                    {
                        var saveString = mainController.ExportMainState();
                        try
                        {
                            await SaveInLocalSave(saveString);
                        }
                        catch
                        {
                            // swallow save errors (e.g. JS disconnected)
                        }
                    }
                }
                catch { }

                await Task.Delay(1000, token);
            }
        }
        catch (OperationCanceledException) { }
        catch { }
    }

    private async Task SaveInLocalSave(string json)
    {
        Log("Saving game state to local save");
        await JS.InvokeVoidAsync("setLocalSave", AutosaveKey, json);
        Log("Game state saved to local save");
    }

    private void StopAutosaveLoop()
    {
        autosaveCts?.Cancel();
        autosaveCts = null;
    }

    public async ValueTask DisposeAsync()
    {
        // request cancellation
        renderLoopCts?.Cancel();
        autosaveCts?.Cancel();

        // wait for tasks to finish, but don't block indefinitely
        var waitTasks = new List<Task>();
        if (renderLoopTask != null) waitTasks.Add(renderLoopTask);
        if (autosaveTask != null) waitTasks.Add(autosaveTask);

        if (waitTasks.Count > 0)
        {
            try
            {
                var all = Task.WhenAll(waitTasks);
                var completed = await Task.WhenAny(all, Task.Delay(5000));
                // ignore timeout; ensure no unobserved exceptions
                try { await all; } catch { }
            }
            catch { }
        }

        StopAutosaveLoop();
    }

    private void OnCitySelected(SettlersOfIdlestan.Model.City.City city)
    {
        selectedCity = city;
        sideBuildMessage = null;
        StateHasChanged();
    }

    private void BuildBuilding(BuildingType type)
    {
        if (selectedCity == null || mainController == null) return;
        try
        {
            mainController.BuildingController.BuildBuilding(selectedCity.CivilizationIndex, selectedCity.Position, type);
            sideBuildMessage = "Bâtiment construit";
        }
        catch (Exception ex)
        {
            sideBuildMessage = ex.Message;
        }
        StateHasChanged();
    }

    private void UpgradeBuilding(BuildingType type)
    {
        if (selectedCity == null || mainController == null) return;
        try
        {
            mainController.BuildingController.BuildBuilding(selectedCity.CivilizationIndex, selectedCity.Position, type);
            sideBuildMessage = "Bâtiment amélioré";
        }
        catch (Exception ex)
        {
            sideBuildMessage = ex.Message;
        }
        StateHasChanged();
    }

    private string FormatCost(System.Collections.Generic.Dictionary<SettlersOfIdlestan.Model.IslandMap.Resource, int> cost)
    {
        if (cost == null || cost.Count == 0) return "Aucun coût";
        return string.Join(", ", cost.Select(kv => $"{kv.Value} {kv.Key}"));
    }

    private void Log(string message)
    {
        Console.WriteLine($"[MainPage] {message}");
        Debug.WriteLine($"[MainPage] {message}");
    }
}
