@page "/"
@attribute [StreamRendering]
@rendermode InteractiveServer

@using SettlersOfIdlestanGame.Components
@using SettlersOfIdlestanGame.Components.Elements
@using SettlersOfIdlestan.Model.IslandMap
@using SettlersOfIdlestan.Controller
@using SettlersOfIdlestan.Model.Civilization
@using System.Collections.Generic
@using System.Threading
@using System.Threading.Tasks
@using System.Diagnostics

<PageTitle>Settlers of Idlestan</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="mb-0">Carte de l'île</h1>

    <div class="resource-capsule d-flex align-items-center px-3 py-1 rounded-pill"
         style="background:#f8f9fa;border:1px solid #ddd;min-width:220px;max-width:60%;">
        @if (State is null)
        {
            <span class="text-muted">Chargement ressources…</span>
        }
        else
        {
            @foreach (var rObj in System.Enum.GetValues(typeof(SettlersOfIdlestan.Model.IslandMap.Resource)))
            {
                var r = (SettlersOfIdlestan.Model.IslandMap.Resource)rObj;
                var qty = State.PlayerCivilization.GetResourceQuantity(r);
                <div class="me-3 d-flex align-items-center">
                    <span class="badge bg-secondary me-1" style="min-width:26px;text-align:center">
                        @r.ToString().Substring(0,1)
                    </span>
                    <small class="text-nowrap">@r.ToString(): @qty</small>
                </div>
            }
        }
    </div>
</div>

<div class="mb-2">
    <button class="btn btn-primary" @onclick="Generate">Générer / Régénérer</button>
</div>

@if (State is null)
{
    <p><em>Génération en cours...</em></p>
}
else
{
    <IslandMapView State="State" Controller="mainController" />
}

@code {
    private IslandState? State;
    private MainGameController? mainController;
    private CancellationTokenSource? renderLoopCts;
    private Stopwatch? renderLoopStopwatch;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(50);

        // Create main controller and a new game
        mainController = new MainGameController();

        var tileData = new List<(TerrainType, int)>
        {
            (TerrainType.Forest, 4),
            (TerrainType.Hill, 3),
            (TerrainType.Pasture, 4),
            (TerrainType.Field, 4),
            (TerrainType.Mountain, 3),
            (TerrainType.Desert, 1)
        };

        var mainState = mainController.CreateNewGame(tileData, 1);
        State = mainState!.CurrentIslandState;

        // start clock and render loop
        if (mainController.Clock != null)
        {
            mainController.Clock.Start();
            StartRenderLoop();
        }

        StateHasChanged();
    }

    private void Generate()
    {
        if (mainController == null) mainController = new MainGameController();

        var tileData = new List<(TerrainType, int)>
        {
            (TerrainType.Forest, 4),
            (TerrainType.Hill, 3),
            (TerrainType.Pasture, 4),
            (TerrainType.Field, 4),
            (TerrainType.Mountain, 3),
            (TerrainType.Desert, 1)
        };

        var mainState = mainController.CreateNewGame(tileData, 1);
        State = mainState!.CurrentIslandState;

        // restart clock and render loop for the new controller
        renderLoopCts?.Cancel();
        if (mainController.Clock != null)
        {
            mainController.Clock.Start();
            StartRenderLoop();
        }

        StateHasChanged();
    }

    private void StartRenderLoop()
    {
        // cancel previous loop if any
        renderLoopCts?.Cancel();

        renderLoopCts = new CancellationTokenSource();
        renderLoopStopwatch = Stopwatch.StartNew();

        var token = renderLoopCts.Token;
        _ = Task.Run(async () =>
        {
            try
            {
                while (!token.IsCancellationRequested)
                {
                    var sw = renderLoopStopwatch!;
                    var elapsed = sw.Elapsed;
                    sw.Restart();

                    try
                    {
                        if (mainController?.Clock != null)
                        {
                            mainController.Clock.Advance(elapsed);
                        }
                    }
                    catch
                    {
                        // ignore clock advance errors
                    }

                    // trigger UI update so child components can reflect clock changes
                    try { await InvokeAsync(StateHasChanged); } catch { }

                    // aim for ~60fps; actual delta comes from stopwatch
                    await Task.Delay(16, token);
                }
            }
            catch (OperationCanceledException) { }
            catch { }
        }, token);
    }

    public async ValueTask DisposeAsync()
    {
        renderLoopCts?.Cancel();
        await Task.CompletedTask;
    }
}
